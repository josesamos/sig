[["index.html", "Almacenar Información Geográfica en PostGIS Sistemas de Información Geográfica 1 Introducción", " Almacenar Información Geográfica en PostGIS Sistemas de Información Geográfica José Samos Jiménez (jsamos@ugr.es) Dpto. de Lenguajes y Sistemas Informáticos Universidad de Granada Curso 2024-2025 Citar y Licencia: https://doi.org/10.6084/m9.figshare.26966668.v1 1 Introducción En primer lugar, hemos obtenido información geográfica relevante para nuestro municipio. Posteriormente, hemos recortado los datos ráster y vectoriales obtenidos seleccionando exclusivamente el área de nuestro municipio. En esta actividad, como punto de partida, vamos a trabajar con datos obtenidos anteriormente. Tenemos los datos vectoriales en formato GeoPackage y los datos ráster en formato GeoTIFF. Es imprescindible tener disponibles los datos obtenidos en el tema anterior para poder continuar. Almacenaremos una selección de estos datos en PostGIS, basándonos en la funcionalidad que ofrecen QGIS y R. Como resultado obtendremos una BD (base de datos) con la información geográfica de nuestro municipio. La BD obtenida en esta actividad deberá conservarse y estar disponible para ser utilizada en las actividades que desarrollaremos en los temas siguientes. Las actividades propuestas para PostGIS se basan principalmente en Marquez (2015) y Obe and Hsu (2015). Objetivos El objetivo principal es almacenar los datos obtenidos en un SGBD espacial, en concreto, PostGIS. Saber cómo crear una BD en PostGIS, con la extensión espacial. Estudiar cómo incluir datos ráster y vectoriales en la BD desde QGIS y R. Conocer cómo se integra el SGBD con QGIS y R. Poder visualizar datos de la BD desde QGIS. Referencias Marquez, Angel. 2015. PostGIS Essentials. Packt Publishing. Obe, Regina O., and Leo S. Hsu. 2015. PostGIS in Action (Second Edition). Manning. "],["datos-partida.html", "2 Datos de partida", " 2 Datos de partida Para el municipio seleccionado, los datos de partida que necesitamos los hemos obtenido en el capítulo Transformar e Integrar Información Geográfica. Aquí se vuelven a detallar. Zona de trabajo, un archivo en formato GeoPackage con dos capas: término municipal nombre: compuesto por el nombre del municipio (8 letras, sin espacios), -, y usuario de correo (p.e, lanjaron-jsamos) mínimo rectángulo que contiene al término municipal nombre: nombre anterior pero con -bbox- en lugar de - (p.e, lanjaron-bbox-jsamos) Para cada capa, se indica el primer componente del nombre que ha de tener. Son los siguientes: capas temáticas: capa de líneas sobre vías de comunicación nombre: tem-viac- capas temáticas: capa de líneas sobre red hidrográfica nombre: tem-redh- capas temáticas: capa de puntos sobre cualquier tema nombre: tem-punt- capas temáticas: capa de polígonos sobre cualquier tema nombre: tem-poli- archivos de ortofotografía reciente que abarque todo el rectángulo del municipio nombre: ort- archivos de MDT que abarque todo el rectángulo del municipio nombre: mdt- un archivo de CartoCiudad con las capas con datos de manzana y portal de la provincia nombres: cc-manz- y cc-port-, respectivamente un archivo de CORINE Land Cover, en formato GeoPackage, solo la capa CLC18_ES nombre: clc- bandas de satélite, de la última fecha disponible, que abarque todo el rectángulo del municipio, si es posible, sin nubes nombre: sat- si se ha generado cada banda en un archivo, añadir el nombre de la banda a cada uno (p.e., sat-b1-, sat-b2-, etc.) si se han generado las bandas en archivos, clasificadas por su resolución, añadir el identificador de la resolución a cada uno (p.e., sat-r10m-, sat-r20m-, etc.) Tenemos dos versiones de cada capa, obtenidas al recortar la capa original mediante las capas: término municipal mínimo rectángulo que contiene al término municipal Los nombres de las capas están compuestos por: el nombre que se indica para cada capa en la lista numerada anterior, seguido del nombre de la capa con la que se ha recortado. Las dos versiones de cada capa vectorial están en un mismo archivo en formato GeoPackage, cuyo nombre coincide con la capa obtenida al realizar el recorte por la capa término municipal. Todas las capas vectoriales tienen el mismo CRS: proyección UTM del datum ETRS89 de la zona del municipio. Cada capa ráster, tiene el CRS original que tenía al descargarla. "],["postgresql-y-postgis.html", "3 PostgreSQL y PostGIS 3.1 Crear una BD PostgreSQL con las extensiones postgis y postgis_raster 3.2 Guardar en un archivo y restaurar una BD PostgreSQL", " 3 PostgreSQL y PostGIS PostgreSQL es un sistema de gestión de SGBD relacional de código abierto. PostGIS es una extensión de PostgreSQL que permite definir datos y consultas espaciales1. Mediante PostGIS podemos almacenar directamente capas vectoriales en PostgreSQL, también permite almacenar datos ráster pero transformándolos previamente mediante una utilidad (raster2pgsql) para obtener un archivo SQL. Mediante una extensión de PostGIS, llamada postgis_raster, también se pueden almacenar directamente capas ráster. Antes de trabajar con QGIS o R, tenemos que crear una BD PostGIS que soporte tanto datos vectoriales como datos ráster. A continuación se explica cómo hacerlo, también cómo salvar la BD si, por ejemplo, queremos guardar nuestro trabajo para continuar en otro ordenador. 3.1 Crear una BD PostgreSQL con las extensiones postgis y postgis_raster Para almacenar la información en PostGIS, en primer lugar, deberemos crear una BD y un esquema desde el administrador de PostgreSQL, pgAdmin 4. Figura 3.1: Conectarse a PostgreSQL. Pulsando sobre la flecha a la izquierda de Servers, en la columna de la izquierda de la figura 3.1, se muestran los datos de los servidores disponibles y, si seguimos desplegando de la misma forma, las BD de cada servidor. Al conectarse a un servidor, solicita el usuario y la contraseña (salvo que se le haya indicado antes que la guarde). Figura 3.2: Crear la BD. Para crear una nueva BD, pulsamos sobre Create &gt; Database… del menú contextual del apartado Databases (figura 3.2). En la ventana que se abre, indicamos el nombre de la BD, se muestra el propietario de la BD, en este caso es el administrador cuyo usuario es postgres (no tenemos que cambiarlo) y pulsamos sobre el botón Save. Con esta operación tenemos una BD PostgreSQL. Figura 3.3: Crear una extensión a la BD. Para tener una BD con soporte para información geográfica, debemos añadir una extensión PostGIS a la BD PostgreSQL que acabamos de crear. Esto lo hacemos desde el apartado Extensions, pulsando sobre Create &gt; Extension… en el menú contextual (figura 3.4). Figura 3.4: Añadir la extensión a la BD. En la ventana de creación de extensiones, seleccionamos la extensión postgis y pulsamos sobre el botón Save (figura 3.4). Para que la BD permita trabajar con datos ráster directamente, debemos añadir también la extensión postgis_raster (de la misma forma que acabamos de añadir la extensión postgis). Es decir, la BD ha de tener las extensiones postgis y postgis_raster, además del resto de extensiones que tenga. 3.2 Guardar en un archivo y restaurar una BD PostgreSQL Si trabajamos con PostgreSQL en un ordenador y queremos llevar nuestro trabajo a otro, debemos hacer un Backup de la BD para guardar nuestro trabajo y después hacer Restore. Figura 3.5: Backup y Restore. En el menú contextual de la BD (figura 3.5) encontramos las opciones para realizar estas operaciones. https://postgis.net/↩︎ "],["almacenar-información-desde-r.html", "4 Almacenar información desde R 4.1 Definir la conexión con la BD 4.2 Almacenar una capa vectorial 4.3 Almacenar un ráster 4.4 Finalizar la conexión con la BD 4.5 Funciones de ayuda", " 4 Almacenar información desde R En primer lugar debemos definir una conexión con la BD en el SGBD PostGIS. Después, almacenar las capas. Por último, debemos cerrar la conexión. 4.1 Definir la conexión con la BD Para definir la conexión usamos la función dbConnect del paquete DBI, también incluida en el paquete RPostgres que es el que usamos. Indicamos el nombre de la BD (en mi caso lanjaron_jsamos, que tenemos que haberla creado previamente), y los datos de nuestra instalación. Si queremos comprobar que se ha establecido bien la conexión, mediante la función dbListTables obtenemos una lista de las tablas de la BD. con &lt;- RPostgres::dbConnect( RPostgres::Postgres(), dbname = &#39;lanjaron_jsamos&#39;, host = &#39;localhost&#39;, port = &#39;5432&#39;, user = &#39;postgres&#39;, password = &#39;xxxxxxxx&#39; ) RPostgres::dbListTables(con) # [1] &quot;geography_columns&quot; &quot;geometry_columns&quot; &quot;spatial_ref_sys&quot; &quot;raster_columns&quot; &quot;raster_overviews&quot; 4.2 Almacenar una capa vectorial Para almacenar una capa vectorial en PostGIS desde R también usaremos la función st_write del paquete sf, tal y como se ha hecho para los otros SGBD. La diferencia es que ahora indicamos la conexión (con) en lugar del archivo. sf::st_write(obj = lanjaron_jsamos, dsn = con, layer = &quot;lanjaron_jsamos&quot;) 4.2.1 Copiar estilos de CORINE Land Cover Una vez tengamos las capas de CORINE Land Cover almacenadas en la BD y tenemos la conexión (con), podemos copiar los estilos desde el GeoPackage mediante la función siguiente: from &lt;- &quot;clc-lanjaron-jsamos.gpkg&quot; layers &lt;- c(&quot;clc_lanjaron_bbox_jsamos&quot;, &quot;clc_lanjaron_jsamos&quot;) database &lt;- &quot;lanjaron_jsamos&quot; sigugr::copy_styles_layer_names(from=from, to=con, layers, database) Como en la BD hay más capas, debemos indicar el nombre de las capas a las que aplicar los estilos. 4.3 Almacenar un ráster Para almacenar las capas ráster, usaremos las funciones del paquete rpostgis para escribir en la BD y las funciones del paquete raster para leer las capas. En la función pgWriteRast indicamos mediante un vector el esquema de la BD donde se almacena (las almacenaremos en el esquema public) y la tabla. Esta función no permite usar el carácter ‘-’ en el nombre de las tablas. r &lt;- terra::rast(&quot;mdt-lanjaron-bbox-jsamos.tif&quot;) layer &lt;- &quot;mdt_lanjaron_bbox_jsamos&quot; rpostgis::pgWriteRast(con, c(&quot;public&quot;, layer), raster = r) Esta función almacena todas las bandas del ráster en la misma tabla. Para la ortofotografía es adecuado almacenar todas las bandas en la misma tabla, pero no para las bandas de satélite. 4.3.1 Bandas de satélite Para las bandas de satélite, vamos a almacenar cada banda en una tabla distinta. Podemos usar el código siguiente para acceder a las bandas almacenadas en un archivo. file &lt;- &quot;sat-r30m-lanjaron-bbox-jsamos.tif&quot; sr &lt;- terra::rast(file) for (b in names(sr)) { rb &lt;- sr[[b]] # ... } El nombre de la banda está en b, el ráster con la banda a almacenar en rb. 4.4 Finalizar la conexión con la BD Una vez hemos acabado de operar con la BD, nos desconectamos de ella mediante la función dbDisconnect. RPostgres::dbDisconnect(con) 4.5 Funciones de ayuda En los GeoPackage y los archivos GeoTIFF, en el criterio de nombres que usamos, el separador era el carácter “-”. Para los nombres de tablas en la BD usamos como separador el carácter “_” (en algún caso no hay opción, no puede ser “-”). Mediante la función siguiente se sustituye un carácter por otro en una cadena de caracteres. layer &lt;- gsub(&quot;-&quot;, &quot;_&quot;, layer) "],["almacenar-información-desde-qgis.html", "5 Almacenar información desde QGIS 5.1 Conexión a la BD o creación de la BD 5.2 Añadir capas", " 5 Almacenar información desde QGIS Podemos acceder a las BD de distinto tipo desde el Navegador de QGIS. En el menú contextual de cada tipo de BD podemos acceder a las opciones disponibles. 5.1 Conexión a la BD o creación de la BD Podemos conectarnos a una BD PostGIS existente. Una vez definamos una conexión a una BD podremos acceder a sus capas de la misma forma que si esta estuvieran almacenadas en archivos de tipo vectorial o ráster para trabajar con ellas en nuestro proyecto. Figura 5.1: Opciones de las BD PostGIS en el Navegador. Para conectarnos con una BD seleccionamos la opción Conexión nueva… Figura 5.2: Crear una nueva conexión a PostGIS. En la ventana que se abre definimos los datos de la nueva conexión (figura 5.2). El nombre de la conexión puede ser cualquiera, no tiene que coincidir con el de la BD. Es recomendable pulsar sobre el botón Probar conexión, nos pedirá el usuario y contraseña (en la instalación de la máquina virtual ambos son postgres) y podremos comprobar si se puede conectar a la BD. 5.2 Añadir capas 5.2.1 Añadir capas vectoriales Figura 5.3: Administrador de BBDD. Podemos añadir capas vectoriales desde el Administrador de BBDD. Accedemos a él pulsando sobre Base de datos &gt; Administrador de bases de datos… Además de poder definir nuevas conexiones a BD, podemos importar datos vectoriales pulsando sobre Importar capa/archivo… en la barra de herramientas (figura 5.3). 5.2.2 Añadir capas ráster Como BD podemos añadir capas ráster para PostGIS. Una posibilidad es usar la utilidad raster2pgsql para obtener un archivo SQL a partir de un ráster y así poder insertarlo en la BD. Otra es utilizar el complemento PostGIS Raster Import que, una vez instalado, es accesible desde la opción Base de datos &gt; PostGIS Raster Import. Figura 5.4: PostGIS Raster Import. En la ventana que se abre (figura 5.4), seleccionamos la capa ráster a importar, la conexión de la BD (ha de estar definida previamente), el esquema de la BD (usamos el esquema public) y la tabla donde se almacenará la capa (si no existe la creará). Es importante desmarcar la opción Create Raster Overviews porque, en caso contrario, además del ráster, añade varios más obtenidos a partir de él a distintas resoluciones. "],["almacenar-acceder-mostrar-info.html", "6 Acceder y mostrar información de una BD desde el Administrador de BBDD de QGIS", " 6 Acceder y mostrar información de una BD desde el Administrador de BBDD de QGIS Podemos usar el Administrador de BBDD de QGIS para acceder al contenido de las capas y mostrar una vista previa de estas sin necesidad de añadirlas a un proyecto. Para poder acceder a una BD, debemos definir previamente una conexión a esta, como se describe en el apartado 5.1. Accedemos al Administrador de BBDD pulsando sobre Base de datos &gt; Administrador de bases de datos… Figura 6.1: Vista previa en el Administrador de BBDD. En el apartado Proveedores, en el lateral izquierdo de la ventana que se abre (figura 6.1), seleccionamos la BD desplegando el tipo correspondiente. En esa misma zona, para la BD, seleccionamos la tabla que queremos ver. En la hoja Vista previa, en el lateral derecho, se muestra la capa. "],["ejercicios.html", "Ejercicios", " Ejercicios Herramientas Los ejercicios se podrán realizar con QGIS o R, o con una combinación de ambas, según las preferencias de cada persona. Recomiendo realizarlos en R, entre otros motivos, porque es mucho más fácil (aunque pueda parecer que no). Ejercicio 1. Almacenar en PostGIS Almacena todas las capas del apartado 2 (la zona de trabajo y las capas numeradas, excepto la ortofotografía) en una BD PostGIS cuyo nombre sea el nombre del municipio (8 letras, sin espacios), “_” y tu usuario de correo (p.e., en mi caso lanjaron_jsamos). El nombre de las capas en la BD deberá coincidir con el nombre de los archivos sin extensión (o de las capas en los archivos) de los que proceden, sustituyendo “-” por “_“. Para las bandas de satélite, el nombre de las capas en la BD estará compuesto por el nombre de la banda, con el prefijo compuesto por sat_ y la resolución (p.e., sat_r30m_), y el sufijo correspondiente al nombre de la capa de recorte que su usó. Por ejemplo, en mi caso, los nombres para la banda 1, para Landasat 8 son sat_r30m_B1_lanjaron_bbox_jsamos y sat_r30m_B1_lanjaron_jsamos. Ortofotografía (ort-) \\(\\rightarrow\\) Por su gran tamaño, NO es necesario almacenarla en la BD para completar el ejercicio. Para documentar la realización del ejercicio: genera un documento PDF incluye en primer lugar un apartado con las capturas de pantalla de pgAdmin donde se muestren los nombres de todas las tablas de la BD (2 capturas deben ser suficientes) con un apartado para cada conjunto de datos almacenado, de la lista del apartado 2 en el apartado de la ortofotografía, incluye en su lugar las capas de la zona de trabajo en cada apartado, para cada capa almacenada (2 capas), incluye una captura de pantalla completa de QGIS donde se muestre la previsualización, en el Administrador de BBDD, tal y como se explica en el apartado 6 para las bandas de satélite, para documentar la realización del ejercicio, es suficiente con mostrar una de las bandas (si está disponible a varias resoluciones, a una de las resoluciones) En un apartado final (también se puntuará) si se ha desarrollado mediante R, incluye el código R generado para realizar la actividad si se ha desarrollado mediante QGIS, en cada apartado de los conjuntos de datos almacenados, incluye adicionalmente una captura de pantalla de la operación realizada. La BD obtenida en este tema deberá conservarse y estar disponible para ser utilizada en las actividades que desarrollaremos en los temas siguientes. "],["referencias.html", "Referencias", " Referencias Marquez, Angel. 2015. PostGIS Essentials. Packt Publishing. Obe, Regina O., and Leo S. Hsu. 2015. PostGIS in Action (Second Edition). Manning. "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
